<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–æ—á–Ω–∞—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è - TimeTracker</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
      }
      .container {
        max-width: 400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
        font-size: 24px;
      }
      .status {
        text-align: center;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        font-weight: bold;
      }
      .loading {
        background: rgba(255, 193, 7, 0.3);
      }
      .success {
        background: rgba(40, 167, 69, 0.3);
      }
      .error {
        background: rgba(220, 53, 69, 0.3);
      }

      button {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        margin: 10px 0;
        transition: all 0.3s;
      }
      button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .info {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        font-size: 14px;
      }
      .location-details {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        font-size: 12px;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéØ –¢–æ—á–Ω–∞—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è</h1>

      <div id="status" class="status loading">–ì–æ—Ç–æ–≤ –∫ –ø–æ–ª—É—á–µ–Ω–∏—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏</div>

      <button id="checkInBtn" onclick="checkIn()">
        üìç –û—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ
      </button>

      <button id="checkOutBtn" onclick="checkOut()">
        üö™ –û—Ç–º–µ—Ç–∏—Ç—å—Å—è —Å —Ä–∞–±–æ—Ç—ã
      </button>

      <div class="info">
        <strong>–ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è:</strong><br />
        ‚Ä¢ GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–≤—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å)<br />
        ‚Ä¢ WiFi —Å–µ—Ç–∏ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏<br />
        ‚Ä¢ –í—Ä–µ–º—è –∏ –¥–∞—Ç–∞<br />
        ‚Ä¢ –¢–æ—á–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è<br />
        ‚Ä¢ –ú–æ–¥–µ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      </div>

      <div
        id="locationDetails"
        class="location-details"
        style="display: none"
      ></div>
    </div>

    <script>
      let userId = null;
      let userName = null;

      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ Telegram WebApp
      function initUser() {
        const urlParams = new URLSearchParams(window.location.search);
        userId = urlParams.get("user_id");
        userName = urlParams.get("user_name");

        // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω Telegram WebApp API
        if (window.Telegram && window.Telegram.WebApp) {
          const tg = window.Telegram.WebApp;
          tg.ready();

          if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userId = tg.initDataUnsafe.user.id;
            userName = tg.initDataUnsafe.user.first_name;
          }
        }
      }

      // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—ã—Å–æ–∫–æ—Ç–æ—á–Ω–æ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
      async function getHighAccuracyLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"));
            return;
          }

          const options = {
            enableHighAccuracy: true,
            timeout: 30000,
            maximumAge: 0,
          };

          navigator.geolocation.getCurrentPosition(
            (position) => resolve(position),
            (error) => reject(error),
            options
          );
        });
      }

      // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ WiFi (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
      async function getNetworkInfo() {
        const info = {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if ("connection" in navigator) {
          info.connection = {
            effectiveType: navigator.connection.effectiveType,
            downlink: navigator.connection.downlink,
            rtt: navigator.connection.rtt,
          };
        }

        return info;
      }

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      async function sendLocationData(type, locationData) {
        try {
          const response = await fetch("/api/location", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: userId,
              user_name: userName,
              type: type, // 'check_in' –∏–ª–∏ 'check_out'
              ...locationData,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          return await response.json();
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
          throw error;
        }
      }

      // –û—Ç–º–µ—Ç–∫–∞ –ø—Ä–∏—Ö–æ–¥–∞ –Ω–∞ —Ä–∞–±–æ—Ç—É
      async function checkIn() {
        await performLocationAction("check_in", "–û—Ç–º–µ—á–∞–µ–º—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ...");
      }

      // –û—Ç–º–µ—Ç–∫–∞ —É—Ö–æ–¥–∞ —Å —Ä–∞–±–æ—Ç—ã
      async function checkOut() {
        await performLocationAction("check_out", "–û—Ç–º–µ—á–∞–µ–º—Å—è —Å —Ä–∞–±–æ—Ç—ã...");
      }

      // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π
      async function performLocationAction(actionType, loadingText) {
        const statusDiv = document.getElementById("status");
        const detailsDiv = document.getElementById("locationDetails");
        const checkInBtn = document.getElementById("checkInBtn");
        const checkOutBtn = document.getElementById("checkOutBtn");

        try {
          // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
          checkInBtn.disabled = true;
          checkOutBtn.disabled = true;

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
          statusDiv.className = "status loading";
          statusDiv.textContent = loadingText;

          // –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
          const position = await getHighAccuracyLocation();
          const networkInfo = await getNetworkInfo();

          const locationData = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy,
            altitude: position.coords.altitude,
            altitudeAccuracy: position.coords.altitudeAccuracy,
            heading: position.coords.heading,
            speed: position.coords.speed,
            timestamp: new Date().toISOString(),
            networkInfo: networkInfo,
          };

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
          detailsDiv.innerHTML = `
                    <strong>–î–∞–Ω–Ω—ã–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:</strong><br>
                    –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${position.coords.latitude.toFixed(
                      6
                    )}, ${position.coords.longitude.toFixed(6)}<br>
                    –¢–æ—á–Ω–æ—Å—Ç—å: ¬±${Math.round(position.coords.accuracy)}–º<br>
                    –í—Ä–µ–º—è: ${new Date().toLocaleString()}<br>
                    –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${networkInfo.platform}<br>
                    –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${networkInfo.timezone}
                `;
          detailsDiv.style.display = "block";

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          const result = await sendLocationData(actionType, locationData);

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
          statusDiv.className = "status success";
          statusDiv.textContent =
            actionType === "check_in"
              ? "‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ—á–µ–Ω –ø—Ä–∏—Ö–æ–¥ –Ω–∞ —Ä–∞–±–æ—Ç—É!"
              : "‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ—á–µ–Ω —É—Ö–æ–¥ —Å —Ä–∞–±–æ—Ç—ã!";

          // –ï—Å–ª–∏ –µ—Å—Ç—å Telegram WebApp, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ
          if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.sendData(
              JSON.stringify({
                action: actionType,
                success: true,
                location: locationData,
              })
            );
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞:", error);
          statusDiv.className = "status error";
          statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;

          detailsDiv.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${error.message}`;
          detailsDiv.style.display = "block";
        } finally {
          // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ
          checkInBtn.disabled = false;
          checkOutBtn.disabled = false;
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener("DOMContentLoaded", function () {
        initUser();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        if (!navigator.geolocation) {
          document.getElementById("status").className = "status error";
          document.getElementById("status").textContent =
            "‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
          document.getElementById("checkInBtn").disabled = true;
          document.getElementById("checkOutBtn").disabled = true;
        }
      });
    </script>
  </body>
</html>
